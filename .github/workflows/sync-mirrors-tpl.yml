name: Universal Repo Mirror Sync

on:
  schedule:
    # UTCæ—¶é—´ï¼š18:30 å’Œ 06:30ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ 02:30 å’Œ 14:30
    - cron: '30 18,6 * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼ï¼šowner/repo)'
        required: true
        default: 'MetaCubeX/meta-rules-dat'
      target_repo_1:
        description: 'ç›®æ ‡ä»“åº“1åœ°å€ (æ ¼å¼ï¼šowner/repo)'
        required: true
        default: 'timeflysoon/meta-rules-dat'
      target_repo_2:
        description: 'ç›®æ ‡ä»“åº“2åœ°å€ (æ ¼å¼ï¼šowner/repo)'
        required: true
        default: '88alt/meta-rules-dat'

jobs:
  sync-mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 1. æ˜¾ç¤ºè¿è¡Œä¿¡æ¯ä¸Žå‚æ•°
        run: |
          echo "=== é€šç”¨é•œåƒåŒæ­¥ä»»åŠ¡å¯åŠ¨ ==="
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è§¦å‘æ—¶é—´ (UTC): $(date '+%Y-%m-%d %H:%M:%S')"
          echo "åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo ""
          echo "é…ç½®å‚æ•°:"
          echo "  æºä»“åº“ : ${{ github.event.inputs.source_repo }}"
          echo "  ç›®æ ‡ä»“åº“1: ${{ github.event.inputs.target_repo_1 }}"
          echo "  ç›®æ ‡ä»“åº“2: ${{ github.event.inputs.target_repo_2 }}"

      - name: 2. è®¾ç½®SSHå¯†é’¥å¯¹ï¼ˆåŠ¨æ€é€‚é…ï¼‰
        run: |
          echo "é…ç½®SSHçŽ¯å¢ƒï¼ˆåŠ¨æ€é€‚é…ç›®æ ‡ä»“åº“ï¼‰..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # åŠ¨æ€ç”Ÿæˆç›®æ ‡ä»“åº“åˆ—è¡¨å’Œæ˜ å°„å…³ç³»
          TARGET_1_OWNER=$(echo "${{ github.event.inputs.target_repo_1 }}" | cut -d'/' -f1)
          TARGET_2_OWNER=$(echo "${{ github.event.inputs.target_repo_2 }}" | cut -d'/' -f1)
          
          # å†™å…¥å¯¹åº”çš„ç§é’¥ï¼ˆSecretsåç§°éœ€ä¸Žä»“åº“æ‰€æœ‰è€…å¯¹åº”ï¼Œå¦‚ SSH_PRIVATE_KEY_OWNERï¼‰
          echo "${{ secrets.SSH_PRIVATE_KEY_T }}" > ~/.ssh/id_$TARGET_1_OWNER
          echo "${{ secrets.SSH_PRIVATE_KEY_X1 }}" > ~/.ssh/id_$TARGET_2_OWNER
          chmod 600 ~/.ssh/id_$TARGET_1_OWNER ~/.ssh/id_$TARGET_2_OWNER
          
          # åŠ¨æ€ç”ŸæˆSSHé…ç½®
          cat > ~/.ssh/config << EOF
          # ç›®æ ‡ä»“åº“1é…ç½®
          Host github-$TARGET_1_OWNER
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_$TARGET_1_OWNER
            IdentitiesOnly yes
            StrictHostKeyChecking no
          
          # ç›®æ ‡ä»“åº“2é…ç½®
          Host github-$TARGET_2_OWNER
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_$TARGET_2_OWNER
            IdentitiesOnly yes
            StrictHostKeyChecking no
          EOF
          
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          
          echo "âœ… SSHé…ç½®å®Œæˆ"
          echo "å·²ä¸ºä»¥ä¸‹ä»“åº“åˆ›å»ºé…ç½®ï¼š"
          echo "  - ${{ github.event.inputs.target_repo_1 }} (å¯†é’¥: ~/.ssh/id_$TARGET_1_OWNER)"
          echo "  - ${{ github.event.inputs.target_repo_2 }} (å¯†é’¥: ~/.ssh/id_$TARGET_2_OWNER)"

      - name: 3. éªŒè¯SSHè¿žæŽ¥
        run: |
          echo "éªŒè¯SSHå¯†é’¥è¿žæŽ¥..."
          
          TARGET_1_OWNER=$(echo "${{ github.event.inputs.target_repo_1 }}" | cut -d'/' -f1)
          TARGET_2_OWNER=$(echo "${{ github.event.inputs.target_repo_2 }}" | cut -d'/' -f1)
          
          # æµ‹è¯•ç¬¬ä¸€ä¸ªå¯†é’¥
          echo "æµ‹è¯• $TARGET_1_OWNER ä»“åº“è¿žæŽ¥..."
          if ssh -T git@github-$TARGET_1_OWNER 2>&1 | grep -q "$TARGET_1_OWNER"; then
            echo "âœ… å¯†é’¥ $TARGET_1_OWNER è¿žæŽ¥æˆåŠŸ"
          else
            echo "âŒ å¯†é’¥ $TARGET_1_OWNER è¿žæŽ¥å¤±è´¥"
            exit 1
          fi
          
          # æµ‹è¯•ç¬¬äºŒä¸ªå¯†é’¥
          echo "æµ‹è¯• $TARGET_2_OWNER ä»“åº“è¿žæŽ¥..."
          if ssh -T git@github-$TARGET_2_OWNER 2>&1 | grep -q "$TARGET_2_OWNER"; then
            echo "âœ… å¯†é’¥ $TARGET_2_OWNER è¿žæŽ¥æˆåŠŸ"
          else
            echo "âŒ å¯†é’¥ $TARGET_2_OWNER è¿žæŽ¥å¤±è´¥"
            exit 1
          fi
          
          echo "æ‰€æœ‰SSHè¿žæŽ¥éªŒè¯é€šè¿‡"

      - name: 4. é…ç½®Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --global core.sshCommand "ssh -F ~/.ssh/config"
          git config --global init.defaultBranch main
          echo "âœ… Gité…ç½®å®Œæˆ"

      - name: 5. å…‹éš†æºä»“åº“
        run: |
          echo "æ­£åœ¨å…‹éš†æºä»“åº“..."
          
          SOURCE_REPO="https://github.com/${{ github.event.inputs.source_repo }}.git"
          echo "æºä»“åº“URL: $SOURCE_REPO"
          
          CLONE_START=$(date +%s)
          
          MAX_RETRY=3
          for i in $(seq 1 $MAX_RETRY); do
            echo "å…‹éš†å°è¯• $i/$MAX_RETRY..."
            
            rm -rf source-repo.git 2>/dev/null || true
            
            if git clone --mirror "$SOURCE_REPO" source-repo.git; then
              CLONE_END=$(date +%s)
              CLONE_DURATION=$((CLONE_END - CLONE_START))
              echo "âœ… å…‹éš†æˆåŠŸï¼Œè€—æ—¶: ${CLONE_DURATION}ç§’"
              break
            elif [ $i -eq $MAX_RETRY ]; then
              echo "âŒ å…‹éš†å¤±è´¥ï¼ˆå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰"
              exit 1
            else
              echo "å…‹éš†å¤±è´¥ï¼Œ10ç§’åŽé‡è¯• ($i/$MAX_RETRY)..."
              sleep 10
            fi
          done
          
          cd source-repo.git
          
          echo "åº”ç”¨Gité…ç½®è§„åˆ™..."
          git config --unset-all remote.origin.fetch 2>/dev/null || true
          git config --add remote.origin.fetch '+refs/heads/*:refs/heads/*'
          git config --add remote.origin.fetch '+refs/tags/*:refs/tags/*'
          
          {
              git for-each-ref --format='delete %(refname)' refs/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null
          } 2>/dev/null || echo "æ— æœ¬åœ°PRå¼•ç”¨å¯æ¸…ç†"
          
          {
              git for-each-ref --format='delete %(refname)' refs/remotes/origin/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null
          } 2>/dev/null || echo "æ— è¿œç¨‹PRå¼•ç”¨å¯æ¸…ç†"
          
          echo "èŽ·å–æœ€æ–°æ›´æ–°..."
          git fetch --prune origin
          
          echo "ä»“åº“ä¿¡æ¯:"
          echo "  åˆ†æ”¯: $(git branch -r | wc -l)"
          echo "  æ ‡ç­¾: $(git tag | wc -l)"
          echo "  å¤§å°: $(du -sh . | cut -f1)"
          
          cd ..

      - name: 6. æ‰§è¡Œé•œåƒåŒæ­¥
        run: |
          set -e
          
          cd source-repo.git
          
          echo "=== å¼€å§‹åŒæ­¥é•œåƒä»“åº“ $(date '+%Y-%m-%d %H:%M:%S') UTC ==="
          
          TARGET_1_OWNER=$(echo "${{ github.event.inputs.target_repo_1 }}" | cut -d'/' -f1)
          TARGET_2_OWNER=$(echo "${{ github.event.inputs.target_repo_2 }}" | cut -d'/' -f1)
          
          TARGET_REPOS=(
            "git@github-$TARGET_1_OWNER:${{ github.event.inputs.target_repo_1 }}.git"
            "git@github-$TARGET_2_OWNER:${{ github.event.inputs.target_repo_2 }}.git"
          )
          
          SYNC_START_TIME=$(date +%s)
          
          for TARGET_REPO in "${TARGET_REPOS[@]}"; do
            REPO_HOST=$(echo "$TARGET_REPO" | cut -d'@' -f2 | cut -d':' -f1)
            REPO_PATH=$(echo "$TARGET_REPO" | cut -d':' -f2)
            
            echo "=== æŽ¨é€é•œåƒåˆ°: $REPO_PATH ==="
            
            REPO_START_TIME=$(date +%s)
            
            MAX_RETRY=2
            for i in $(seq 1 $MAX_RETRY); do
              echo "æŽ¨é€å°è¯• $i/$MAX_RETRY..."
              if git push --mirror "$TARGET_REPO"; then
                REPO_END_TIME=$(date +%s)
                REPO_DURATION=$((REPO_END_TIME - REPO_START_TIME))
                
                BRANCHES_COUNT=$(git branch -r | wc -l)
                TAGS_COUNT=$(git tag | wc -l)
                
                echo "âœ… æŽ¨é€æˆåŠŸ"
                echo "  åˆ†æ”¯: $BRANCHES_COUNT, æ ‡ç­¾: $TAGS_COUNT, è€—æ—¶: ${REPO_DURATION}ç§’"
                break
              elif [ $i -eq $MAX_RETRY ]; then
                echo "âŒ æŽ¨é€å¤±è´¥ï¼ˆå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰"
                break
              else
                echo "æŽ¨é€å¤±è´¥ï¼Œ10ç§’åŽé‡è¯• ($i/$MAX_RETRY)..."
                sleep 10
              fi
            done
          done
          
          SYNC_END_TIME=$(date +%s)
          TOTAL_DURATION=$((SYNC_END_TIME - SYNC_START_TIME))
          
          echo "=== åŒæ­¥å®Œæˆï¼Œæ€»è€—æ—¶: ${TOTAL_DURATION}ç§’ ==="

      - name: 7. æ¸…ç†æ•æ„Ÿæ•°æ®
        if: always()
        run: |
          echo "æ¸…ç†SSHå¯†é’¥æ–‡ä»¶..."
          TARGET_1_OWNER=$(echo "${{ github.event.inputs.target_repo_1 }}" | cut -d'/' -f1)
          TARGET_2_OWNER=$(echo "${{ github.event.inputs.target_repo_2 }}" | cut -d'/' -f1)
          rm -f ~/.ssh/id_$TARGET_1_OWNER ~/.ssh/id_$TARGET_2_OWNER
          rm -f ~/.ssh/config
          rm -f ~/.ssh/known_hosts
          echo "âœ… æ•æ„Ÿæ•°æ®æ¸…ç†å®Œæˆ"

      - name: 8. ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸš€ é€šç”¨é•œåƒåŒæ­¥ä»»åŠ¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**è¿è¡Œä¿¡æ¯**:" >> $GITHUB_STEP_SUMMARY
          echo "- è§¦å‘æ–¹å¼: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡ŒçŠ¶æ€: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡ŒID: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**åŒæ­¥é…ç½®**:" >> $GITHUB_STEP_SUMMARY
          echo "- æºä»“åº“: [${{ github.event.inputs.source_repo }}](https://github.com/${{ github.event.inputs.source_repo }})" >> $GITHUB_STEP_SUMMARY
          echo "- ç›®æ ‡ä»“åº“1: [${{ github.event.inputs.target_repo_1 }}](https://github.com/${{ github.event.inputs.target_repo_1 }})" >> $GITHUB_STEP_SUMMARY
          echo "- ç›®æ ‡ä»“åº“2: [${{ github.event.inputs.target_repo_2 }}](https://github.com/${{ github.event.inputs.target_repo_2 }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… **æ‰§è¡Œç»“æžœ**: åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰ç›®æ ‡ä»“åº“å‡å·²åŒæ­¥æœ€æ–°å†…å®¹ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æ‰§è¡Œç»“æžœ**: åŒæ­¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—æŽ’æŸ¥é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S') UTC" >> $GITHUB_STEP_SUMMARY
