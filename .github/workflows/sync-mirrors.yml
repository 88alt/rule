name: Sync Mirror Repositories

on:
  schedule:
    # UTCæ—¶é—´ï¼š18:30 å’Œ 06:30ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ 02:30 å’Œ 14:30
    - cron: '30 18,6 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå³ä½¿æ²¡æœ‰æ–°æäº¤ä¹Ÿæ‰§è¡Œï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  sync-mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 1. éªŒè¯è§¦å‘æ¡ä»¶
        run: |
          echo "=== é•œåƒåŒæ­¥ä»»åŠ¡å¯åŠ¨ ==="
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è§¦å‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S') UTC"
          echo "åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "æ‰‹åŠ¨è§¦å‘å‚æ•°:"
            echo "  - å¼ºåˆ¶åŒæ­¥: ${{ github.event.inputs.force_sync }}"
          fi

      - name: 2. è®¾ç½®SSHå¯†é’¥å¯¹
        run: |
          echo "é…ç½®SSHçŽ¯å¢ƒ..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # å†™å…¥ä¸¤ä¸ªç‹¬ç«‹çš„ç§é’¥
          echo "${{ secrets.SSH_PRIVATE_KEY_T }}" > ~/.ssh/id_ed25519_t
          echo "${{ secrets.SSH_PRIVATE_KEY_X1 }}" > ~/.ssh/id_ed25519_x1
          chmod 600 ~/.ssh/id_ed25519_t ~/.ssh/id_ed25519_x1
          
          # é…ç½®SSHä¸»æœºåˆ«å
          cat > ~/.ssh/config << 'EOF'
          # timeflysoonä»“åº“ä¸“ç”¨é…ç½®
          Host github-t
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_ed25519_t
            IdentitiesOnly yes
            StrictHostKeyChecking no
            ConnectTimeout 10
          
          # 88altä»“åº“ä¸“ç”¨é…ç½®
          Host github-x1
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_ed25519_x1
            IdentitiesOnly yes
            StrictHostKeyChecking no
            ConnectTimeout 10
          EOF
          
          # æ·»åŠ GitHubä¸»æœºæŒ‡çº¹
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          
          echo "âœ… SSHé…ç½®å®Œæˆ"

      - name: 3. éªŒè¯SSHè¿žæŽ¥
        run: |
          echo "=== éªŒè¯SSHå¯†é’¥è¿žæŽ¥ ==="
          
          # æµ‹è¯•ç¬¬ä¸€ä¸ªå¯†é’¥
          echo "æµ‹è¯• timeflysoon ä»“åº“è¿žæŽ¥..."
          if ssh -T git@github-t 2>&1 | grep -q "timeflysoon"; then
            echo "âœ… å¯†é’¥Tè¿žæŽ¥æˆåŠŸ"
          else
            echo "âŒ å¯†é’¥Tè¿žæŽ¥å¤±è´¥"
            ssh -T git@github-t
            exit 1
          fi
          
          # æµ‹è¯•ç¬¬äºŒä¸ªå¯†é’¥
          echo "æµ‹è¯• 88alt ä»“åº“è¿žæŽ¥..."
          if ssh -T git@github-x1 2>&1 | grep -q "88alt"; then
            echo "âœ… å¯†é’¥X1è¿žæŽ¥æˆåŠŸ"
          else
            echo "âŒ å¯†é’¥X1è¿žæŽ¥å¤±è´¥"
            ssh -T git@github-x1
            exit 1
          fi
          
          echo "=== æ‰€æœ‰SSHè¿žæŽ¥éªŒè¯é€šè¿‡ ==="

      - name: 4. é…ç½®Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --global core.sshCommand "ssh -F ~/.ssh/config"
          git config --global init.defaultBranch main
          git config --global pull.rebase false
          git config --global advice.detachedHead false
          
          echo "âœ… Gité…ç½®å®Œæˆ"

      - name: 5. å…‹éš†æºä»“åº“
        run: |
          echo "æ­£åœ¨å…‹éš†æºä»“åº“..."
          
          # è®¾ç½®æºä»“åº“URLï¼ˆè¿™é‡Œæ˜¯å®žé™…çš„å¼€æºä»“åº“ï¼‰
          SOURCE_REPO="https://github.com/MetaCubeX/meta-rules-dat.git"
          echo "æºä»“åº“: $SOURCE_REPO"
          
          # è®°å½•å¼€å§‹æ—¶é—´
          CLONE_START=$(date +%s)
          
          # å…‹éš†ä»“åº“ï¼ˆè®¾ç½®é‡è¯•æœºåˆ¶ï¼‰
          MAX_RETRY=3
          for i in $(seq 1 $MAX_RETRY); do
            echo "å…‹éš†å°è¯• $i/$MAX_RETRY..."
            
            # åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›®å½•
            rm -rf meta-rules-dat.git 2>/dev/null || true
            
            if git clone --mirror "$SOURCE_REPO" meta-rules-dat.git; then
              # è®°å½•ç»“æŸæ—¶é—´
              CLONE_END=$(date +%s)
              CLONE_DURATION=$((CLONE_END - CLONE_START))
              
              echo "âœ… å…‹éš†æˆåŠŸï¼Œè€—æ—¶: ${CLONE_DURATION}ç§’"
              break
            elif [ $i -eq $MAX_RETRY ]; then
              echo "âŒ å…‹éš†å¤±è´¥ï¼ˆå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰"
              echo "é”™è¯¯: æ— æ³•å…‹éš†æºä»“åº“ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œè¿žæŽ¥"
              echo "URL: $SOURCE_REPO"
              exit 1
            else
              echo "å…‹éš†å¤±è´¥ï¼Œ10ç§’åŽé‡è¯• ($i/$MAX_RETRY)..."
              sleep 10
            fi
          done
          
          # è¿›å…¥ä»“åº“ç›®å½•
          cd meta-rules-dat.git
          
          # åº”ç”¨å…³é”®é…ç½®
          echo "åº”ç”¨Gité…ç½®è§„åˆ™..."
          
          # 1. æ°¸ä¹…æ€§é…ç½®ï¼šåªæŠ“å–åˆ†æ”¯å’Œæ ‡ç­¾
          git config --unset-all remote.origin.fetch 2>/dev/null || true
          git config --add remote.origin.fetch '+refs/heads/*:refs/heads/*'
          git config --add remote.origin.fetch '+refs/tags/*:refs/tags/*'
          
          # 2. æ¸…ç†åŽ†å²é—ç•™çš„PRå¼•ç”¨ï¼ˆç¬¬ä¸€æ¬¡å…‹éš†æ—¶é€šå¸¸æ²¡æœ‰ï¼Œä½†ä¸ºäº†å®‰å…¨ï¼‰
          {
              git for-each-ref --format='delete %(refname)' refs/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null
          } 2>/dev/null || echo "æ— æœ¬åœ°PRå¼•ç”¨å¯æ¸…ç†"
          
          {
              git for-each-ref --format='delete %(refname)' refs/remotes/origin/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null
          } 2>/dev/null || echo "æ— è¿œç¨‹PRå¼•ç”¨å¯æ¸…ç†"
          
          # 3. èŽ·å–æœ€æ–°æ›´æ–°ï¼ˆå®žé™…ä¸Šåˆšå…‹éš†å®Œï¼Œè¿™ä¸€æ­¥å¯èƒ½ä¸éœ€è¦ï¼Œä½†ä¸ºäº†ç»Ÿä¸€æµç¨‹ï¼‰
          echo "èŽ·å–æœ€æ–°æ›´æ–°..."
          if git fetch --prune origin; then
            echo "âœ… èŽ·å–æˆåŠŸ"
          else
            echo "âŒ èŽ·å–å¤±è´¥"
            exit 1
          fi
          
          # è¾“å‡ºä»“åº“ä¿¡æ¯
          echo "ä»“åº“ä¿¡æ¯:"
          echo "  åˆ†æ”¯æ•°é‡: $(git branch -r | wc -l 2>/dev/null || echo '0')"
          echo "  æ ‡ç­¾æ•°é‡: $(git tag | wc -l 2>/dev/null || echo '0')"
          echo "  æœ€è¿‘æäº¤: $(git log --oneline -1 2>/dev/null || echo 'æ— æäº¤è®°å½•')"
          echo "  ä»“åº“å¤§å°: $(du -sh . | cut -f1)"
          
          cd ..

      - name: 6. æ‰§è¡Œé•œåƒåŒæ­¥
        run: |
          set -e
          
          cd meta-rules-dat.git
          
          echo "=== å¼€å§‹åŒæ­¥é•œåƒä»“åº“ $(date '+%Y-%m-%d %H:%M:%S') UTC ==="
          echo "åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
          
          # ç›®æ ‡ä»“åº“åˆ—è¡¨
          TARGET_REPOS=(
            "git@github-t:timeflysoon/meta-rules-dat.git"
            "git@github-x1:88alt/meta-rules-dat.git"
          )
          
          # æŽ¨é€åˆ°æ‰€æœ‰ç›®æ ‡ä»“åº“
          SYNC_START_TIME=$(date +%s)
          
          for TARGET_REPO in "${TARGET_REPOS[@]}"; do
            REPO_HOST=$(echo "$TARGET_REPO" | cut -d'@' -f2 | cut -d':' -f1)
            REPO_PATH=$(echo "$TARGET_REPO" | cut -d':' -f2)
            
            echo "=== æŽ¨é€é•œåƒåˆ°: $REPO_HOST/$REPO_PATH ==="
            
            # è®°å½•å•ä¸ªä»“åº“å¼€å§‹æ—¶é—´
            REPO_START_TIME=$(date +%s)
            
            MAX_RETRY=2
            for i in $(seq 1 $MAX_RETRY); do
              echo "æŽ¨é€å°è¯• $i/$MAX_RETRY..."
              if git push --mirror "$TARGET_REPO"; then
                # è®¡ç®—æŽ¨é€æ—¶é—´
                REPO_END_TIME=$(date +%s)
                REPO_DURATION=$((REPO_END_TIME - REPO_START_TIME))
                
                # ç»Ÿè®¡æŽ¨é€å†…å®¹
                BRANCHES_COUNT=$(git branch -r | wc -l)
                TAGS_COUNT=$(git tag | wc -l)
                
                echo "âœ… æŽ¨é€æˆåŠŸ"
                echo "  æŽ¨é€ç»Ÿè®¡: $BRANCHES_COUNT ä¸ªåˆ†æ”¯, $TAGS_COUNT ä¸ªæ ‡ç­¾"
                echo "  æŽ¨é€è€—æ—¶: ${REPO_DURATION}ç§’"
                break
              elif [ $i -eq $MAX_RETRY ]; then
                echo "âŒ æŽ¨é€å¤±è´¥ï¼ˆå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰"
                echo "::warning::æŽ¨é€ $REPO_PATH å¤±è´¥"
                # è®°å½•å¤±è´¥ä½†ä¸é€€å‡ºï¼Œç»§ç»­å°è¯•å…¶ä»–ä»“åº“
                break
              else
                echo "æŽ¨é€å¤±è´¥ï¼Œ10ç§’åŽé‡è¯• ($i/$MAX_RETRY)..."
                sleep 10
              fi
            done
          done
          
          # è®¡ç®—æ€»åŒæ­¥æ—¶é—´
          SYNC_END_TIME=$(date +%s)
          TOTAL_DURATION=$((SYNC_END_TIME - SYNC_START_TIME))
          
          echo "=== åŒæ­¥å®Œæˆ $(date '+%Y-%m-%d %H:%M:%S') UTC ==="
          echo "åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
          echo "æ€»åŒæ­¥è€—æ—¶: ${TOTAL_DURATION}ç§’"

      - name: 7. æ¸…ç†æ•æ„Ÿæ•°æ®
        if: always()
        run: |
          echo "æ¸…ç†SSHå¯†é’¥æ–‡ä»¶..."
          rm -f ~/.ssh/id_ed25519_t
          rm -f ~/.ssh/id_ed25519_x1
          rm -f ~/.ssh/config
          rm -f ~/.ssh/known_hosts
          
          echo "âœ… æ•æ„Ÿæ•°æ®æ¸…ç†å®Œæˆ"

      - name: 8. ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸš€ é•œåƒåŒæ­¥ä»»åŠ¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åŸºæœ¬è¿è¡Œä¿¡æ¯
          echo "### ðŸ“Š è¿è¡Œæ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ—¶é—´ (UTC)**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒ—äº¬æ—¶é—´**: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»»åŠ¡çŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡ŒID**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **æºä»“åº“**: [MetaCubeX/meta-rules-dat](https://github.com/MetaCubeX/meta-rules-dat)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åŒæ­¥ç›®æ ‡
          echo "### ðŸŽ¯ åŒæ­¥ç›®æ ‡" >> $GITHUB_STEP_SUMMARY
          echo "| ä»“åº“ | SSHå¯†é’¥ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| timeflysoon/meta-rules-dat | å¯†é’¥T | å¾…åŒæ­¥ |" >> $GITHUB_STEP_SUMMARY
          echo "| 88alt/meta-rules-dat | å¯†é’¥X1 | å¾…åŒæ­¥ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ‰§è¡Œç»“æžœ
          echo "### ðŸ“‹ æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "**çŠ¶æ€**: âœ… åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰ç›®æ ‡ä»“åº“å·²æˆåŠŸåŒæ­¥æœ€æ–°å†…å®¹ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ³¨æ„**: æ¯æ¬¡è¿è¡Œéƒ½ä¼šå®Œæ•´å…‹éš†æºä»“åº“ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "**çŠ¶æ€**: âŒ åŒæ­¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "é•œåƒåŒæ­¥ä»»åŠ¡å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—æŽ’æŸ¥é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å¸¸è§é—®é¢˜:" >> $GITHUB_STEP_SUMMARY
            echo "1. æºä»“åº“URLæ˜¯å¦æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
            echo "2. SSHå¯†é’¥é…ç½®æ˜¯å¦æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
            echo "3. ç›®æ ‡ä»“åº“Deploy Keysæ˜¯å¦æœ‰å†™å…¥æƒé™" >> $GITHUB_STEP_SUMMARY
            echo "4. ç½‘ç»œè¿žæŽ¥æ˜¯å¦æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´ (UTC): $(date '+%Y-%m-%d %H:%M:%S')*" >> $GITHUB_STEP_SUMMARY
          echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´ (åŒ—äº¬æ—¶é—´): $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')*" >> $GITHUB_STEP_SUMMARY
