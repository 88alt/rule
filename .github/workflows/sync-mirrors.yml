name: Sync Mirror Repositories

on:
  schedule:
    - cron: '30 2,14 * * *'  # UTC时间
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  sync-mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 设置SSH密钥对（两对独立密钥）
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # 写入第一对密钥（用于timeflysoon仓库）
          echo "${{ secrets.SSH_PRIVATE_KEY_T }}" > ~/.ssh/id_ed25519_t
          chmod 600 ~/.ssh/id_ed25519_t
          
          # 写入第二对密钥（用于88alt仓库）
          echo "${{ secrets.SSH_PRIVATE_KEY_X1 }}" > ~/.ssh/id_ed25519_x1
          chmod 600 ~/.ssh/id_ed25519_x1
          
          # 配置SSH主机别名，每个仓库使用不同的密钥
          cat >> ~/.ssh/config << 'EOF'
          # timeflysoon仓库专用配置
          Host github-t
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_ed25519_t
            StrictHostKeyChecking no
            IdentitiesOnly yes
          
          # 88alt仓库专用配置
          Host github-x1
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_ed25519_x1
            StrictHostKeyChecking no
            IdentitiesOnly yes
          EOF
          
          # 添加GitHub到已知主机
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          
          echo "SSH密钥配置完成"
          echo "密钥文件列表："
          ls -la ~/.ssh/
          
          # 测试密钥连接（可选，帮助调试）
          echo "测试SSH密钥连接..."
          ssh -T git@github.com 2>&1 | head -5 || true

      - name: 配置Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --global credential.helper cache
          git config --global init.defaultBranch main
          git config --global pull.rebase false

      - name: 克隆源仓库
        run: |
          echo "正在克隆源仓库..."
          rm -rf meta-rules-dat.git 2>/dev/null || true
          
          # ⚠️ 替换为实际的源仓库URL
          SOURCE_REPO="https://github.com/某个开源组织/meta-rules-dat.git"
          echo "克隆源仓库: $SOURCE_REPO"
          
          git clone --mirror "$SOURCE_REPO" meta-rules-dat.git
          
          cd meta-rules-dat.git
          echo "仓库信息:"
          echo "  大小: $(du -sh . | cut -f1)"
          echo "  分支: $(git branch -r | wc -l)"
          echo "  标签: $(git tag | wc -l)"

      - name: 执行镜像同步
        run: |
          set -e
          
          cd meta-rules-dat.git
          
          # 配置目标仓库（使用不同的SSH主机别名）
          TARGET_REPOS=(
            "git@github-t:timeflysoon/meta-rules-dat.git"
            "git@github-x1:88alt/meta-rules-dat.git"
          )
          
          echo "=== 开始同步镜像仓库 $(date '+%Y-%m-%d %H:%M:%S') ==="
          echo "目标仓库数量: ${#TARGET_REPOS[@]}"
          
          # 1. 永久性配置：只抓取分支和标签
          echo "配置源仓库只抓取分支和标签..."
          git config --unset-all remote.origin.fetch 2>/dev/null || true
          git config --add remote.origin.fetch '+refs/heads/*:refs/heads/*'
          git config --add remote.origin.fetch '+refs/tags/*:refs/tags/*'
          
          # 2. 清理历史遗留的PR引用
          echo "清理PR引用..."
          {
              git for-each-ref --format='delete %(refname)' refs/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null 2>/dev/null
          } || echo "无本地PR引用可清理"
          
          {
              git for-each-ref --format='delete %(refname)' refs/remotes/origin/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null 2>/dev/null
          } || echo "无远程PR引用可清理"
          
          # 3. 获取最新更新
          echo "从源仓库获取最新更新..."
          RETRY_COUNT=0
          MAX_RETRY=3
          
          while [ $RETRY_COUNT -lt $MAX_RETRY ]; do
            if git fetch --prune origin; then
              FETCHED_COUNT=$(git log --oneline HEAD..origin/HEAD 2>/dev/null | wc -l || echo "0")
              echo "✓ 获取成功，新提交: $FETCHED_COUNT"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "✗ 获取失败，尝试 $RETRY_COUNT/$MAX_RETRY..."
              if [ $RETRY_COUNT -eq $MAX_RETRY ]; then
                echo "错误：获取更新失败！"
                exit 1
              fi
              sleep 10
            fi
          done
          
          # 4. 推送到所有目标仓库（每个使用不同的密钥）
          for TARGET_REPO in "${TARGET_REPOS[@]}"; do
            # 提取仓库标识符
            REPO_HOST=$(echo "$TARGET_REPO" | cut -d'@' -f2 | cut -d':' -f1)
            REPO_PATH=$(echo "$TARGET_REPO" | cut -d':' -f2 | sed 's/.git$//')
            echo "=== 推送镜像到: $REPO_HOST:$REPO_PATH ==="
            
            # 测试SSH连接
            echo "测试连接到 $REPO_HOST..."
            if ssh -o ConnectTimeout=5 -T git@$REPO_HOST 2>&1 | grep -q "successfully authenticated"; then
              echo "✓ SSH连接成功"
            else
              echo "⚠️ SSH连接测试无响应（继续尝试推送）"
            fi
            
            # 推送镜像
            MAX_RETRY=2
            for i in $(seq 1 $MAX_RETRY); do
              echo "推送尝试 $i/$MAX_RETRY..."
              if git push --mirror "$TARGET_REPO"; then
                # 推送成功后获取统计信息
                BRANCHES_PUSHED=$(git branch -r | wc -l)
                TAGS_PUSHED=$(git tag | wc -l)
                echo "✓ 推送成功"
                echo "  推送统计: $BRANCHES_PUSHED 分支, $TAGS_PUSHED 标签"
                break
              elif [ $i -eq $MAX_RETRY ]; then
                echo "✗ 推送失败（已达最大重试次数）"
                echo "::warning::推送 $REPO_PATH 失败"
                # 记录失败但不退出，继续尝试其他仓库
                break
              else
                echo "推送失败，10秒后重试 ($i/$MAX_RETRY)..."
                sleep 10
              fi
            done
          done
          
          echo "=== 同步完成 $(date '+%Y-%m-%d %H:%M:%S') ==="

      - name: 清理敏感数据
        if: always()
        run: |
          echo "清理SSH密钥文件..."
          rm -f ~/.ssh/id_ed25519_t
          rm -f ~/.ssh/id_ed25519_x1
          rm -f ~/.ssh/config
          rm -rf ~/.ssh/known_hosts
          
          # 验证清理
          echo "清理后~/.ssh目录内容:"
          ls -la ~/.ssh/ 2>/dev/null || echo "~/.ssh目录不存在"
          
          echo "✅ 敏感数据清理完成"

      - name: 生成运行报告
        if: always()
        run: |
          echo "## 镜像同步任务报告" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**运行时间**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**任务状态**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**同步目标**: " >> $GITHUB_STEP_SUMMARY
          echo "- timeflysoon/meta-rules-dat（使用独立密钥T）" >> $GITHUB_STEP_SUMMARY
          echo "- 88alt/meta-rules-dat（使用独立密钥X1）" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "✅ 同步任务执行成功" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ 同步任务执行失败" >> $GITHUB_STEP_SUMMARY
            echo "请查看日志排查问题" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 失败通知
        if: failure()
        run: |
          echo "::error::镜像同步任务失败！"
          echo "请检查以下事项："
          echo "1. 源仓库URL是否正确：https://github.com/某个开源组织/meta-rules-dat.git"
          echo "2. SSH密钥是否正确配置："
          echo "   - 私钥已添加到Actions仓库Secrets"
          echo "   - 对应公钥已添加到目标仓库Deploy Keys"
          echo "   - Deploy Keys已开启写入权限"
          echo "3. 网络连接是否正常"
          echo "4. 仓库权限是否足够"
