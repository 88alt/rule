# 文件名: .github/workflows/sync-meta.yml
# 日常使用的同步工作流 - 与源仓库完全一致

name: Sync Meta Folders Only

on:
  schedule:
    - cron: '30 18 * * *'  # UTC 18:30 = 北京时间第二天 2:30
    - cron: '30 6 * * *'   # UTC 6:30 = 北京时间 14:30
  workflow_dispatch:  # 手动触发

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Step 1: Delete meta directory and commit
        id: delete_step
        run: |
          echo "=== 第一步：删除 meta 目录 ==="
          
          # 检查并记录删除前的状态
          if [ -d "meta" ]; then
            echo "找到 meta 目录，正在删除..."
            FILES_BEFORE=$(find meta -type f | wc -l)
            FOLDERS_BEFORE=$(find meta -type d | wc -l)
            echo "删除前：$FILES_BEFORE 个文件，$FOLDERS_BEFORE 个目录"
            
            rm -rf meta
            echo "✅ meta 目录已删除"
            
            # 提交删除操作
            git add -A
            if git diff --cached --quiet; then
              echo "⚠️  没有检测到删除变化，创建空提交..."
              TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
              COMMIT_MSG="🗑️ 删除 meta 目录（第一步）

              为重新同步准备，删除现有 meta 目录。

              详细信息:
              - 操作时间: $TIMESTAMP
              - 删除文件数: $FILES_BEFORE
              - 删除目录数: $FOLDERS_BEFORE

              由 GitHub Actions 自动执行"
              git commit --allow-empty -m "$COMMIT_MSG"
            else
              echo "检测到删除变化，提交删除操作..."
              TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
              COMMIT_MSG="🗑️ 删除 meta 目录（第一步）

              为重新同步准备，删除现有 meta 目录。

              详细信息:
              - 操作时间: $TIMESTAMP
              - 删除文件数: $FILES_BEFORE
              - 删除目录数: $FOLDERS_BEFORE

              由 GitHub Actions 自动执行"
              git commit -m "$COMMIT_MSG"
            fi
            
            # 推送删除提交
            git push origin main
            echo "✅ 已提交并推送删除操作"
            echo "deleted=true" >> $GITHUB_OUTPUT
          else
            echo "ℹ️  meta 目录不存在，无需删除"
            echo "⚠️  创建空提交记录开始同步..."
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            COMMIT_MSG="🚀 开始同步 meta 目录（第一步）

            meta 目录不存在，开始全新同步。

            详细信息:
            - 操作时间: $TIMESTAMP
            - 状态: meta 目录不存在，将进行全新克隆

            由 GitHub Actions 自动执行"
            git commit --allow-empty -m "$COMMIT_MSG"
            git push origin main
            echo "✅ 已创建开始同步记录"
            echo "deleted=false" >> $GITHUB_OUTPUT
          fi

      - name: Step 2: Clone source and commit new files
        run: |
          echo "=== 第二步：重新克隆并提交 ==="
          
          # 确保 meta 目录被完全删除（二次确认）
          rm -rf meta
          
          echo "📥 克隆源仓库到 meta 目录..."
          
          # 直接克隆源仓库到 meta 目录
          git clone --depth=1 --branch=meta https://github.com/MetaCubeX/meta-rules-dat.git meta
          
          echo "克隆完成，清理不需要的目录..."
          
          # 删除源仓库的 .git 目录（我们不想要子仓库）
          rm -rf meta/.git
          
          # 确保没有 .github 目录（如果源仓库有）
          rm -rf meta/.github 2>/dev/null || true
          
          echo "✅ 克隆完成"
          
          # 检查 .dat 文件
          echo "🔍 检查是否有 .dat 文件..."
          if find meta -name "*.dat" -type f 2>/dev/null | grep -q .; then
            echo "发现 .dat 文件，正在删除..."
            find meta -name "*.dat" -type f -delete
            echo "✅ 已删除 .dat 文件"
          else
            echo "✓ 没有 .dat 文件"
          fi

      - name: Step 3: Add and commit new files
        run: |
          echo "=== 第三步：添加并提交新文件 ==="
          
          # 添加所有新文件
          git add -A
          
          # 获取文件统计
          FILES_ADDED=$(find meta -type f | wc -l)
          FOLDERS_ADDED=$(find meta -type d | wc -l)
          
          echo "新增：$FILES_ADDED 个文件，$FOLDERS_ADDED 个目录"
          
          # 构建提交信息
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SYNC_TYPE="手动同步"
          else
            SYNC_TYPE="定时同步"
          fi
          
          COMMIT_MSG="🔄 $SYNC_TYPE: 完成 meta 目录同步

          保持与源仓库完全一致，同步所有文件夹和文件。

          详细信息:
          - 源仓库: MetaCubeX/meta-rules-dat@meta 分支
          - 同步时间: $TIMESTAMP
          - 同步类型: $SYNC_TYPE
          - 新增文件数: $FILES_ADDED
          - 新增目录数: $FOLDERS_ADDED
          - 触发方式: ${{ github.event_name }}
          - 同步方式: 全新克隆（确保完全一致）

          由 GitHub Actions 自动执行"
          
          echo "提交信息:"
          echo "$COMMIT_MSG"
          
          # 提交新文件
          git commit -m "$COMMIT_MSG"
          
          # 推送更新
          git push origin main
          
          echo "✅ 已提交并推送新增文件"

      - name: Final summary
        run: |
          echo "=== 同步任务完成 ==="
          echo "完成时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "触发方式: ${{ github.event_name }}"
          
          echo "✅ 结果: 已完成全新同步（两步提交）"
          
          echo ""
          echo "meta 目录最终状态:"
          if [ -d "meta" ]; then
            ls -la meta/
            
            echo ""
            echo "目录统计:"
            for dir in meta/*/; do
              if [ -d "$dir" ]; then
                dir_name=$(basename "$dir")
                file_count=$(find "$dir" -type f | wc -l)
                dir_time=$(stat -c %y "$dir" 2>/dev/null || stat -f %Sm "$dir" 2>/dev/null || echo "unknown")
                echo "  📁 $dir_name: $file_count 个文件, 更新时间: $dir_time"
              fi
            done
          else
            echo "❌ 错误: meta 目录不存在"
            exit 1
          fi
          
          echo ""
          echo "同步验证:"
          echo "1. ✅ 删除操作已提交"
          echo "2. ✅ 新增文件已提交"
          echo "3. ✅ 目录时间戳已更新"
          
          echo ""
          echo "任务状态: 完成 ✓"
